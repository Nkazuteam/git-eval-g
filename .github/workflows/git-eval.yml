name: Git-Eval G Rank

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Evaluate
        id: eval
        run: |
          SCORE=0
          FEEDBACK=""

          # Detect script type
          HAS_PS1=false
          HAS_SH=false
          [ -f task.ps1 ] && HAS_PS1=true
          [ -f task.sh ] && HAS_SH=true

          # Check 1: Script file exists (20pts)
          if [ "$HAS_PS1" = true ] || [ "$HAS_SH" = true ]; then
            SCORE=$((SCORE + 20))
            if [ "$HAS_PS1" = true ]; then
              FEEDBACK="${FEEDBACK}✅ task.ps1 が存在します\n"
              SCRIPT="task.ps1"
            else
              FEEDBACK="${FEEDBACK}✅ task.sh が存在します\n"
              SCRIPT="task.sh"
            fi
          else
            FEEDBACK="${FEEDBACK}❌ task.ps1 または task.sh が見つかりません\n"
            SCRIPT=""
          fi

          # Check 2: Valid syntax (20pts)
          if [ "$HAS_SH" = true ]; then
            if bash -n task.sh 2>/dev/null; then
              SCORE=$((SCORE + 20))
              FEEDBACK="${FEEDBACK}✅ bash 構文チェック OK\n"
            else
              FEEDBACK="${FEEDBACK}❌ bash 構文エラーがあります\n"
            fi
          elif [ "$HAS_PS1" = true ]; then
            # PowerShell syntax check not available on ubuntu, give points if file is non-empty
            if [ -s task.ps1 ]; then
              SCORE=$((SCORE + 20))
              FEEDBACK="${FEEDBACK}✅ task.ps1 の内容を確認しました\n"
            else
              FEEDBACK="${FEEDBACK}❌ task.ps1 が空です\n"
            fi
          fi

          # Check 3: mkdir command (10pts)
          if [ -n "$SCRIPT" ]; then
            if grep -qiE '(mkdir|New-Item.*Directory)' "$SCRIPT"; then
              SCORE=$((SCORE + 10))
              FEEDBACK="${FEEDBACK}✅ ディレクトリ作成コマンドあり\n"
            else
              FEEDBACK="${FEEDBACK}❌ mkdir / New-Item が見つかりません\n"
            fi
          fi

          # Check 4: File operations (10pts)
          if [ -n "$SCRIPT" ]; then
            if grep -qiE '(cp |mv |echo .+>|Copy-Item|Move-Item|Out-File|Set-Content|New-Item.*File)' "$SCRIPT"; then
              SCORE=$((SCORE + 10))
              FEEDBACK="${FEEDBACK}✅ ファイル操作コマンドあり\n"
            else
              FEEDBACK="${FEEDBACK}❌ ファイル操作コマンドが見つかりません (cp, mv, echo > 等)\n"
            fi
          fi

          # Check 5: List command (10pts)
          if [ -n "$SCRIPT" ]; then
            if grep -qiE '(ls|dir|Get-ChildItem)' "$SCRIPT"; then
              SCORE=$((SCORE + 10))
              FEEDBACK="${FEEDBACK}✅ 一覧表示コマンドあり\n"
            else
              FEEDBACK="${FEEDBACK}❌ ls / Get-ChildItem が見つかりません\n"
            fi
          fi

          # Check 6: No CRLF in .sh files (10pts)
          if [ "$HAS_SH" = true ]; then
            if grep -Pl '\r$' task.sh 2>/dev/null | grep -q .; then
              FEEDBACK="${FEEDBACK}❌ task.sh に CRLF 改行が含まれています\n"
            else
              SCORE=$((SCORE + 10))
              FEEDBACK="${FEEDBACK}✅ 改行コード OK\n"
            fi
          elif [ "$HAS_PS1" = true ]; then
            # PS1 on Windows: CRLF is acceptable
            SCORE=$((SCORE + 10))
            FEEDBACK="${FEEDBACK}✅ PowerShell スクリプト: 改行コードチェック不要\n"
          fi

          # Check 7: At least 2 commits (10pts)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          if [ "$COMMIT_COUNT" -ge 2 ]; then
            SCORE=$((SCORE + 10))
            FEEDBACK="${FEEDBACK}✅ コミット数: ${COMMIT_COUNT}\n"
          else
            FEEDBACK="${FEEDBACK}❌ コミットが 2 つ以上必要です (現在: ${COMMIT_COUNT})\n"
          fi

          # Check 8: Meaningful commit messages (10pts)
          BAD_MSGS=$(git log --format='%s' | grep -ciE '^(initial commit|update|fix|test|asdf|aaa|wip|tmp|\.+)$' || true)
          if [ "$BAD_MSGS" -lt "$COMMIT_COUNT" ] && [ "$COMMIT_COUNT" -gt 0 ]; then
            SCORE=$((SCORE + 10))
            FEEDBACK="${FEEDBACK}✅ コミットメッセージ OK\n"
          else
            FEEDBACK="${FEEDBACK}❌ コミットメッセージを具体的に書きましょう\n"
          fi

          FEEDBACK="${FEEDBACK}\n合計スコア: ${SCORE}/100"

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          {
            echo "feedback<<EVAL_EOF"
            echo -e "$FEEDBACK"
            echo "EVAL_EOF"
          } >> $GITHUB_OUTPUT

      - name: Send results to Git-Eval
        if: always()
        env:
          WEBHOOK_SECRET: ${{ secrets.GIT_EVAL_SECRET }}
          WEBHOOK_URL: ${{ secrets.GIT_EVAL_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ] || [ -z "$WEBHOOK_SECRET" ]; then
            echo "Webhook not configured, skipping"
            exit 0
          fi

          BODY=$(jq -n \
            --arg user "${{ github.actor }}" \
            --argjson score ${{ steps.eval.outputs.score }} \
            --arg feedback "${{ steps.eval.outputs.feedback }}" \
            '{github_username: $user, score: $score, feedback: $feedback}')

          SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

          curl -sf -X POST "${WEBHOOK_URL}/webhook/eval" \
            -H "Content-Type: application/json" \
            -H "X-Signature-256: sha256=${SIG}" \
            -d "$BODY"
